---
layout: lesson
title: Self JOIN
previous_lesson: /lessons/full-outer-join/
next_lesson: /lessons/union-and-union-all/
---

<h3 class="h3-big-margin"><span class="grey-text-span">SQL order of operations</span></h3>
<table class="table-with-header">
  <thead><th>Step</th><th>Clause</th><th>Description</th></thead>
  <tbody>
    <tr><td>1</td><td>FROM</td><td>Chooses the data to get the data from.</td></tr>
    <tr><td>2</td><td>JOIN</td><td>Join tables.</td></tr>
    <tr><td>3</td><td>WHERE</td><td>Filters the data.</td></tr>
    <tr><td>4</td><td>GROUP BY</td><td>Aggregates the data.</td></tr>
    <tr><td>5</td><td>HAVING</td><td>Filters the aggregated data.</td></tr>
    <tr><td>6</td><td>SELECT</td><td>Returns the final data.</td></tr>
    <tr><td>7</td><td>ORDER BY</td><td>Sorts the final data.</td></tr>
    <tr><td>8</td><td>LIMIT</td><td>Limits the number of rows displayed.</td></tr>
  </tbody>
</table>

<h3 class="h3-big-margin"><span class="grey-text-span">Example</span></h3>
<pre>
  <code class="language-sql">
SELECT        DISTINCT product_events.session_id
  FROM        bigquery-public-data.thelook_ecommerce.events product_events
  INNER JOIN  bigquery-public-data.thelook_ecommerce.events cart_events
  ON          product_events.session_id = cart_events.session_id
              AND product_events.created_at > cart_events.created_at
  WHERE       product_events.event_type = 'product'
              AND cart_events.event_type = 'cart';
  </code>
</pre>

<pre>
  <code class="language-sql">
SELECT      created_at, event_type
  FROM      bigquery-public-data.thelook_ecommerce.events
  WHERE     session_id = 'b7c3541d-07d6-4ed9-b483-199f35e07d78'
  ORDER BY  created_at ASC;
  </code>
</pre>

<h3 class="h3-big-margin"><span class="grey-text-span">Best practice</span></h3>
<blockquote><strong>Best practice</strong>: Avoid self-joins. Use a window (analytic) function instead.</blockquote>
<blockquote>Typically, self-joins are used to compute row-dependent relationships. The result of using a self-join is that it potentially squares the number of output rows. This increase in output data can cause poor performance.</blockquote>
<blockquote>Instead of using a self-join, use a window (analytic) function to reduce the number of additional bytes that are generated by the query.<br><br><a href="https://cloud.google.com/bigquery/docs/best-practices-performance-patterns#self-joins">https://cloud.google.com/bigquery/docs/best-practices-performance-patterns#self-joins</a></blockquote>

<p>We'll see window functions later in the course. ðŸ˜‰</a>


<!-- PRACTICE PROBLEMS -->
{% include practice_problems_intructions.html %}

<h3 class="h3-big-margin"><span class="hard-problem-text-span">NÂ°1 â€” Home page funnel drop-off rate in 2022</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.events</p>

  <h4>Task</h4>
  <p>Write a query that will show the percentage of people who didnâ€™t visit a product page after visiting the home page.</p>
  
  <h4>Example results</h4>
  <div class="table-wrapper">
    <table class="table-with-header">
      <thead><th>home_events_users</th><th>home_then_product_users</th><th>dropoff_rate</th></thead>
      <tbody>
        <tr><td>63188</td><td>40371</td><td>36.1</td></tr>
      </tbody>
    </table>
  </div>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">ðŸ™ˆ Hide</a><a href="#" class="show-control">ðŸ‘€ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH home_then_product_events AS
  ( SELECT        e1.user_id AS user_id,
                  e1.session_id,
                  e1.event_type,
                  e1.created_at,
                  e2.event_type,
                  e2.created_at
      
      FROM        bigquery-public-data.thelook_ecommerce.events e1
      
      INNER JOIN  bigquery-public-data.thelook_ecommerce.events e2
      ON          e1.user_id = e2.user_id
                  AND e1.session_id = e2.session_id
                  AND e1.event_type = 'home'
                  AND e2.event_type = 'product'
                  AND e1.created_at < e2.created_at
                  AND FORMAT_DATE('%Y', e1.created_at) = '2022'
                  AND FORMAT_DATE('%Y', e2.created_at) = '2022'
  ),
  
  home_events AS
  (  SELECT COUNT(DISTINCT user_id) AS user_count
      FROM  bigquery-public-data.thelook_ecommerce.events
      WHERE event_type = 'home'
  )

SELECT
  ( SELECT user_count FROM home_events ) AS home_events_users,
  ( SELECT COUNT(DISTINCT user_id) FROM home_then_product_events ) AS home_then_product_users,
  ROUND((1 - (SELECT COUNT(DISTINCT user_id) FROM home_then_product_events) / (SELECT user_count FROM home_events)) * 100, 2)
    AS dropoff_rate;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="hard-problem-text-span">NÂ°2 â€” Google Analytics customers with multiple orders within 5 days in 2022</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.orders</p>

  <h4>Task</h4>
  <p>Write a query that will show the number of customers who have made several orders within five days.</p>
  
  <h4>Example results</h4>
  <div class="table-wrapper">
    <table class="table-with-header">
      <thead><th>five_day_repeat_customers</th></thead>
      <tbody>
        <tr><td>14659</td></tr>
      </tbody>
    </table>
  </div>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">ðŸ™ˆ Hide</a><a href="#" class="show-control">ðŸ‘€ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH five_day_repeats AS
  ( SELECT        o1.user_id AS user_id,
                  o1.order_id AS order_id,
                  o1.created_at AS order_date,
                  o2.order_id AS previous_order_id,
                  o2.created_at AS previous_order_date
      
      FROM        bigquery-public-data.thelook_ecommerce.orders o1
      INNER JOIN  bigquery-public-data.thelook_ecommerce.orders o2
      ON          o1.user_id = o2.user_id
                  AND o2.order_id != o1.order_id
                  AND o2.created_at - o1.created_at <= MAKE_INTERVAL(day => 5)
                  AND FORMAT_DATE('%Y', o1.created_at) = '2022'
                  AND FORMAT_DATE('%Y', o2.created_at) = '2022'
      
      GROUP BY    user_id,
                  order_id,
                  order_date,
                  previous_order_id,
                  previous_order_date
      
      ORDER BY    user_id,
                  order_id,
                  order_date,
                  previous_order_id,
                  previous_order_date
  )

SELECT  COUNT(DISTINCT user_id) AS five_day_repeat_customers
  FROM  five_day_repeats;
        </code>
      </pre>
    </div>
  </div>
</div>
