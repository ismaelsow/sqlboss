---
layout: lesson
title: Self JOIN
quote: "To every man is given the key to the gates of heaven. The same key opens the gates of hell."
previous_lesson: /lessons/full-outer-join/
next_lesson: /lessons/union-and-union-all/
---

<p><img src="images/self-join-illustration.png" class="illustration" /></p>
<p>A self <code>JOIN</code> is a type of <code>JOIN</code> where the same table is used on the left and on the right side. It's useful for example, for finding positional differences between different rows in the same table.</p>
<p>The syntax looks like this: <code>SELECT column A, column B, ..., column N FROM table_1 (INNER or OUTER or LEFT JOIN) table_1 ON matching_set_of_conditions</code>.</p>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 1</span></h3>
<p><strong>Type</strong> the query below in the <a href="https://console.cloud.google.com/bigquery" target="_blank">BigQuery console</a> and run it. Don't copy paste. ðŸ˜‰</p>
<p>
  <pre>
    <code class="language-sql">
SELECT        DISTINCT product_events.session_id

  FROM        bigquery-public-data.thelook_ecommerce.events AS product_events
  INNER JOIN  bigquery-public-data.thelook_ecommerce.events AS cart_events
  ON          product_events.session_id = cart_events.session_id
              AND product_events.created_at > cart_events.created_at

  WHERE       product_events.event_type = 'product'
              AND cart_events.event_type = 'cart';
    </code>
  </pre>
</p>
<p>The example above is a query that lists the ids of the sessions where at one 'product' event happened after a 'cart' event.</p>

<h3 class="h3-big-margin"><span class="grey-text-span">Best practices</span></h3>
<blockquote><strong>Best practice</strong>: Avoid self-joins. Use a window (analytic) function instead.</blockquote>
<blockquote>Typically, self-joins are used to compute row-dependent relationships. The result of using a self-join is that it potentially squares the number of output rows. This increase in output data can cause poor performance.</blockquote>
<blockquote>Instead of using a self-join, use a window (analytic) function to reduce the number of additional bytes that are generated by the query.<br><br><a href="https://cloud.google.com/bigquery/docs/best-practices-performance-patterns#self-joins">https://cloud.google.com/bigquery/docs/best-practices-performance-patterns#self-joins</a></blockquote>

<p>We'll see window functions later in the course. ðŸ˜‰</a>


<!-- PRACTICE PROBLEMS -->
{% include practice_problems_intructions.html %}

<h3 class="h3-big-margin"><span class="hard-problem-text-span">NÂ°1 â€” Home page funnel drop-off rate in 2022&nbsp;ðŸ”¥</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.events</p>

  <h4>Task</h4>
  <p>Write a query that will show the percentage of people who didnâ€™t visit a product page after visiting the home page.</p>
  
  <h4>Example results</h4>
  <div class="table-wrapper">
    <table class="table-with-header">
      <thead><th>home_event_users</th><th>home_event_then_product_event_users</th><th>dropoff_rate</th></thead>
      <tbody>
        <tr><td>62909</td><td>36378</td><td>42.17</td></tr>
      </tbody>
    </table>
  </div>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">ðŸ™ˆ Hide</a><a href="#" class="show-control">ðŸ‘€ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH home_then_product_events AS
  ( SELECT        e1.user_id AS user_id,
                  e1.session_id,
                  e1.event_type,
                  e1.created_at,
                  e2.event_type,
                  e2.created_at
      
      FROM        bigquery-public-data.thelook_ecommerce.events AS e1
      
      INNER JOIN  bigquery-public-data.thelook_ecommerce.events AS e2
      ON          e1.user_id = e2.user_id
                  AND e1.session_id = e2.session_id
                  AND e1.event_type = 'home'
                  AND e2.event_type = 'product'
                  AND e1.created_at < e2.created_at
                  AND FORMAT_DATE('%Y', e1.created_at) = '2022'
                  AND FORMAT_DATE('%Y', e2.created_at) = '2022'
  ),
  
  home_events AS
  (  SELECT COUNT(DISTINCT user_id) AS user_count
      FROM  bigquery-public-data.thelook_ecommerce.events
      WHERE event_type = 'home'
  )

SELECT
  ( SELECT user_count FROM home_events ) AS home_event_users,
  ( SELECT COUNT(DISTINCT user_id) FROM home_then_product_events ) AS home_event_then_product_event_users,
  ROUND((1 - (SELECT COUNT(DISTINCT user_id) FROM home_then_product_events) / (SELECT user_count FROM home_events)) * 100, 2)
    AS dropoff_rate;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="hard-problem-text-span">NÂ°2 â€” Google Analytics customers with multiple orders within 5 days in 2022&nbsp;ðŸ”¥</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.orders</p>

  <h4>Task</h4>
  <p>Write a query that will show the number of customers who have made several orders within five days.</p>
  
  <h4>Example results</h4>
  <div class="table-wrapper">
    <table class="table-with-header">
      <thead><th>five_day_repeat_customers</th></thead>
      <tbody>
        <tr><td>12257</td></tr>
      </tbody>
    </table>
  </div>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">ðŸ™ˆ Hide</a><a href="#" class="show-control">ðŸ‘€ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH five_day_repeats AS
  ( SELECT        o1.user_id AS user_id,
                  o1.order_id AS order_id,
                  o1.created_at AS order_date,
                  o2.order_id AS previous_order_id,
                  o2.created_at AS previous_order_date
      
      FROM        bigquery-public-data.thelook_ecommerce.orders AS o1
      INNER JOIN  bigquery-public-data.thelook_ecommerce.orders AS o2
      ON          o1.user_id = o2.user_id
                  AND o2.order_id != o1.order_id
                  AND o2.created_at - o1.created_at <= MAKE_INTERVAL(DAY => 5)
                  AND FORMAT_DATE('%Y', o1.created_at) = '2022'
                  AND FORMAT_DATE('%Y', o2.created_at) = '2022'
      
      GROUP BY    user_id,
                  order_id,
                  order_date,
                  previous_order_id,
                  previous_order_date
      
      ORDER BY    user_id,
                  order_id,
                  order_date,
                  previous_order_id,
                  previous_order_date
  )

SELECT  COUNT(DISTINCT user_id) AS five_day_repeat_customers
  FROM  five_day_repeats;
        </code>
      </pre>
    </div>
  </div>
</div>
