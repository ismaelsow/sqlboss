---
layout: lesson
title: Aggregate window functions
previous_lesson: /lessons/recursive-queries/
next_lesson: /lessons/row-number/
---

<p>Window functions are functions that:</p>
<ul>
  <li><strong>operate like normal scalar functions</strong>: for 1 column value, they return 1 scalar result. Scalar meaning 1 value, not a table or set of rows.</li>
  <li><strong>but use a group of records (a window) as input</strong> to compute the scalar value that‚Äôs returned.</li>
</ul>

<p>They are very useful to compute percentages, subtotals, cumulative or rolling calculations.</p>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 1</span></h3>
<pre>
  <code class="language-sql">
SELECT  *, ROW_NUMBER() OVER () AS row_num
  FROM  bigquery-public-data.thelook_ecommerce.distribution_centers;
  </code>
</pre>
<p>Notes:</p>
<ul>
  <li><code>ROW_NUMBER()</code> ‚áí <code>ROW_NUMBER</code> is the actual window function, called without parameters. <code>ROW_NUMBER</code> is function that returns the index of the current row in the group of records (window) that‚Äôs used as input.</li>
  <li><code>OVER()</code> ‚áí is a special function that must follow any call to a window function. This is where we define the group of records to use as input for the window function. When <code>OVER()</code> is called without parameters, then the window that‚Äôs used is the entire table.</li>
</ul>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 2</span></h3>
<pre>
  <code class="language-sql">
SELECT  *,  ROW_NUMBER() OVER (PARTITION BY id) AS row_num
  FROM  bigquery-public-data.thelook_ecommerce.distribution_centers;
  </code>
</pre>
<p>Notes:</p>
<ul>
  <li><code>OVER(PARTITION BY id)</code> ‚áí here we define a specific window to use for each row. In this example, the window is the group of records that have the same id as the current row.</li>
  <li>Since there‚Äôs only one record by id, for each row, the window defined has only one record, so the row number is always 1.</li>
</ul>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 3</span></h3>
<pre>
  <code class="language-sql">
SELECT  user_id,
        order_id,
        created_at,
        num_of_item,
        ROW_NUMBER() OVER (PARTITION BY user_id) AS order_number
  
  FROM  bigquery-public-data.thelook_ecommerce.orders;
  </code>
</pre>
<p><img src="images/windows.png" class="lesson-img" /></p>
<p>Notes:</p>
<ul>
  <li><code>OVER(PARTITION BY user_id)</code> ‚áí here we define a specific window to use for each row. In this example, the window is the group of records that have the same user_id as the current row.</li>
  <li>Since there‚Äôs only one record by id, for each row, the window defined has only one record, so the row number is always 1.</li>
  <li>You can see that some of the order_number values seem to be ‚Äúmissing‚Äù from their window. For example, for user_id 1791, we have order_number 3 but order_number 1 and 2 are not visible. It‚Äôs because for now, our table is displayed without any particular order.</li>
</ul>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 4</span></h3>
<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            created_at,
            ROW_NUMBER() OVER (PARTITION BY user_id) AS order_number
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>
<p><img src="images/windows-2.png" class="lesson-img" /></p>
<p>Notes:</p>
<ul>
  <li>Here we can see that by using our usual <code>ORDER BY</code> clause, after the <code>FROM</code> clause, we can order the result (here by user_id) and see the totality of our windows.</li>
  <li>But we can see another issue. If we look at the user_id = 1 window, we can see that the orders in the window are not sorted. We have order_id 1, then 3, then 4, then 2. Same thing for the created_at column. How could we sort the rows inside our windows by order_id or created_at?</li>
</ul>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 5</span></h3>
<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            created_at,
            ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY order_id ASC) AS order_number
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>
<p><code>OVER (PARTITION BY user_id ORDER BY order_id ASC)</code> ‚áí by using the order_id clause inside the over function, we can sort the rows inside our windows. Here we are sorting by order_id.</p>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 6</span></h3>
<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            created_at,
            ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY created_at ASC) AS order_number
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>
<p><code>OVER (PARTITION BY user_id ORDER BY created_at ASC)</code> ‚áí by using the order_id clause inside the over function, we can sort the rows inside our windows. Here we are sorting by created_at.</p>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 7</span></h3>
<p>We can use any of the usual aggregate functions as window functions: <code>COUNT</code>, <code>SUM</code>, <code>AVG</code>, <code>MAX</code>, <code>MIN</code> etc.</p>
<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            COUNT(*) OVER (PARTITION BY user_id) AS order_count
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>
<p>Note that in this example, since we are using an aggregate function, by default the calculated value is the same for every rows of each window, which makes sense.</p>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 8</span></h3>
<p>In addition to sort the rows inside each window, using the <code>ORDER BY</code> clause in the <code>OVER()</code> function will do a cumulative calculation for each row. The calculated value will then be different for every rows of each window.</p>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            COUNT(*) OVER (PARTITION BY user_id) AS order_count
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            COUNT(*) OVER (PARTITION BY user_id ORDER BY order_id ASC) AS order_count
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>

<p><strong>üëà¬†How do cumulative aggregations work behind the hood?</strong></p>
<blockquote> Inside each window is a series of rows called window frames. Some window functions consider only window frame rows, not the entire set of rows in a window. SUM is such a function.</blockquote>
<blockquote>By default, the window frame has all rows of the window. Things change when the OVER() clause has an ORDER BY statement. It narrows the window frame to the rows from the start of the window to the current row + all subsequent rows with the same ORDER BY value.</blockquote>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 9</span></h3>
<p>Using <code>SUM</code> as a window function:</p>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            SUM(num_of_item) OVER (PARTITION BY user_id) AS sum_items
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            SUM(num_of_item) OVER (PARTITION BY user_id ORDER BY order_id ASC) AS sum_items
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 10</span></h3>
<p>Using <code>AVG</code> as a window function:</p>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            AVG(num_of_item) OVER (PARTITION BY user_id) AS avg_items
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            AVG(num_of_item) OVER (PARTITION BY user_id ORDER BY order_id ASC) AS avg_items
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 11</span></h3>
<p>Using <code>MIN</code> as a window function:</p>

<pre>
  <code class="language-sql">
SELECT    user_id,
          order_id,
          num_of_item,
          MIN(num_of_item) OVER (PARTITION BY user_id) AS min_items
  
  FROM    bigquery-public-data.thelook_ecommerce.orders
ORDER BY  user_id;
  </code>
</pre>

<pre>
  <code class="language-sql">
SELECT    user_id,
          order_id,
          num_of_item,
          MIN(num_of_item) OVER (PARTITION BY user_id ORDER BY order_id ASC) AS min_items
  
  FROM    bigquery-public-data.thelook_ecommerce.orders
ORDER BY  user_id;
  </code>
</pre>

<h3 class="h3-big-margin"><span class="grey-text-span">Example 12</span></h3>
<p>Using <code>MAX</code> as a window function:</p>

<pre>
  <code class="language-sql">
SELECT    user_id,
          order_id,
          num_of_item,
          MAX(num_of_item) OVER (PARTITION BY user_id) AS max_items
  
  FROM    bigquery-public-data.thelook_ecommerce.orders
ORDER BY  user_id;
  </code>
</pre>

<pre>
  <code class="language-sql">
SELECT      user_id,
            order_id,
            num_of_item,
            MAX(num_of_item) OVER (PARTITION BY user_id ORDER BY order_id ASC) AS max_items
  
  FROM      bigquery-public-data.thelook_ecommerce.orders
  ORDER BY  user_id;
  </code>
</pre>


<!-- PRACTICE PROBLEMS -->
{% include practice_problems_intructions.html %}

<h3 class="h3-big-margin"><span class="easy-problem-text-span">N¬∞1 ‚Äî Product category with the most products</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.products</p>

  <h4>Task</h4>
  <p>Display the name of the product category with the most products, along with this number.</p>
  
  <h4>Example results</h4>
  <div class="table-wrapper">
    <table class="table-with-header">
      <thead><th>category</th><th>product_count</th></thead>
      <tbody>
        <tr><td>Intimates</td><td>2363</td></tr>
      </tbody>
    </table>
  </div>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
SELECT      category,
            COUNT(*) OVER(PARTITION BY category) AS product_count
  FROM      bigquery-public-data.thelook_ecommerce.products
  ORDER BY  product_count DESC
  LIMIT     1;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="easy-problem-text-span">N¬∞2 ‚Äî Average retail prices per category</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.products</p>

  <h4>Task</h4>
  <ul>
    <li>Write a query that will display the average retail price per category</li>
    <li>Sorted by retail price in descending order</li>
  </ul>
  
  <h4>Example results</h4>
  <p><img src="images/result-2.png" class="lesson-img" /></p>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH subquery AS
  ( SELECT  category,
            ROUND(AVG(retail_price) OVER(PARTITION BY category), 2) AS avg_retail_price
      FROM  bigquery-public-data.thelook_ecommerce.products
  )

SELECT      category,
            MAX(avg_retail_price) AS avg_retail_price
  FROM      subquery
  GROUP BY  category
  ORDER BY  avg_retail_price DESC;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="medium-problem-text-span">N¬∞3 ‚Äî Youngest and oldest age per country</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.users</p>

  <h4>Task</h4>
  <ul>
    <li>Write a query that will display the lowest and highest age numbers for each country, for people who signed up in 2022</li>
    <li>Sort the results by country in ascending order</li>
  </ul>
  
  <h4>Example results</h4>
  <p><img src="images/result-3.png" class="lesson-img" /></p>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH subquery AS
  (  SELECT country,
            MIN(age) OVER(PARTITION BY country) AS min_age,
            MAX(age) OVER (PARTITION BY country) AS max_age
      FROM  bigquery-public-data.thelook_ecommerce.users
      WHERE FORMAT_DATE('%Y', created_at) = '2022'
  )

SELECT      country,
            MIN(min_age) AS min_age,
            MAX(max_age) AS max_age
  FROM      subquery
  GROUP BY  country
  ORDER BY  country ASC;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="hard-problem-text-span">N¬∞4 ‚Äî Number of individual product sales vs average number of product sales per category</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.products</p>
  <p>bigquery-public-data.thelook_ecommerce.order_items</p>

  <h4>Task</h4>
  <p>Write a query that will:</p>
  <ul>
    <li>display the product id</li>
    <li>display the product name</li>
    <li>display the number of individual product sales</li>
    <li>display the product category</li>
    <li>display the average product sales per category</li>
    <li>display the comparison percentage (how many % higher or lower are the individual product sales compared with the category average)</li>
    <li>exclude the products whose names are NULL</li>
    <li>sort the results randomly</li>
  </ul>
  
  <h4>Example results</h4>
  <p><img src="images/result-4.png" class="lesson-img" /></p>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH products_and_order_items AS
  ( SELECT        products.id,
                  category,
                  name
      FROM        bigquery-public-data.thelook_ecommerce.products products
      INNER JOIN  bigquery-public-data.thelook_ecommerce.order_items order_items
      ON          products.id = order_items.product_id
  ),
  
  individual_product_sales AS
  ( SELECT      id,
                name,
                COUNT(*) AS sales,
                category
      FROM      products_and_order_items
      GROUP BY  id,
                name,
                category
  ),

  category_avg_sales AS
  ( SELECT  category,
            AVG(sales) OVER (PARTITION BY category) AS category_avg_sales
      FROM  individual_product_sales
  )

SELECT        id,
              name,
              sales,
              i.category,
              ROUND(category_avg_sales, 2) AS category_avg_sales,
              CONCAT(ROUND(((sales - category_avg_sales) / category_avg_sales) * 100, 2), '%') AS product_vs_category_comparison_percentage
  
  FROM        individual_product_sales i
  INNER JOIN  category_avg_sales c
  ON          i.category = c.category
  WHERE       name IS NOT NULL
  ORDER BY    RAND();
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="medium-problem-text-span">N¬∞5 ‚Äî Percentage of total revenue per category in 2022</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.products</p>
  <p>bigquery-public-data.thelook_ecommerce.order_items</p>

  <h4>Task</h4>
  <ul>
    <li>Write a query that will display the percentage of the total revenue for each product category in 2022.</li>
    <li>Sort the results by the category percentage in descending order</li>
  </ul>
  
  <h4>Example results</h4>
  <p><img src="images/result-5.png" class="lesson-img" /></p>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH total_revenue AS
  ( SELECT  SUM(sale_price) AS revenue
    FROM    bigquery-public-data.thelook_ecommerce.order_items
    WHERE   FORMAT_DATE('%Y', created_at) = '2022'
  ),

  product_category_revenue AS
  ( SELECT        p.id, category, sale_price, o.created_at
      FROM        bigquery-public-data.thelook_ecommerce.products AS p
      INNER JOIN  bigquery-public-data.thelook_ecommerce.order_items AS o
      ON          p.id = o.product_id
      WHERE       FORMAT_DATE('%Y', created_at) = '2022'
  ),

  category_revenue AS
  ( SELECT  category,
            SUM(sale_price) OVER(PARTITION BY category) AS revenue
      FROM  product_category_revenue
  )

SELECT      category,
            ROUND(MAX(revenue), 2) AS category_revenue,
            ROUND((SELECT revenue FROM total_revenue), 2) AS total_revenue,
            ROUND((MAX(revenue) / (SELECT revenue FROM total_revenue) * 100), 2) AS category_percentage
  
  FROM      category_revenue
  GROUP BY  category
  ORDER BY  category_percentage DESC;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="easy-problem-text-span">N¬∞6 ‚Äî Cumulative daily orders of specific customers</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.order_items</p>

  <h4>Task</h4>
  <p>Write a query that will display the cumulative number of orders of the following users each day that they made a purchase: user id 49, 52, 53, 80, 81</p>
  <p>Do not display dates where there were no orders from these users</p>
  
  <h4>Example results</h4>
  <p><img src="images/result-6.png" class="lesson-img" /></p>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH user_selection_orders AS
  ( SELECT  created_at, order_id
      FROM  bigquery-public-data.thelook_ecommerce.orders
      WHERE user_id IN (49, 52, 53, 80, 81)
  )

SELECT  CAST(created_at AS DATE) AS order_date,
        COUNT(order_id) OVER(ORDER BY CAST(created_at AS DATE) ASC) AS cumulative_orders
  FROM  user_selection_orders;
        </code>
      </pre>
    </div>
  </div>
</div>


<h3 class="h3-big-margin"><span class="medium-problem-text-span">N¬∞7 ‚Äî Cumulative daily spend of specific customers</span></h3>
<div class="problem">
  <h4>Tables</h4>
  <p>bigquery-public-data.thelook_ecommerce.order_items</p>

  <h4>Task</h4>
  <ul>
    <li>Write a query that will display the cumulative spend of the following users each day that they made a purchase: user id 49, 52, 53, 80, 81.</li>
    <li>Do not display dates where there were no spending from these users</li>
  </ul>
  
  <h4>Example results</h4>
  <p><img src="images/result-7.png" class="lesson-img" /></p>

  <h4>Solution</h4>
  <div class="collapsible-parent">
    <p><a href="#" class="hide-control">üôà Hide</a><a href="#" class="show-control">üëÄ Show</a></p>
    <div class="practice-problems-instructions collapsible-item">
      <pre>
        <code class="language-sql">
WITH user_selection_orders_items AS
  ( SELECT  created_at, sale_price
      FROM  bigquery-public-data.thelook_ecommerce.order_items
      WHERE user_id IN (49, 52, 53, 80, 81)
  ),

  raw_cumulative_spend AS
  ( SELECT  CAST(created_at AS DATE) AS date_of_spend,
            SUM(sale_price) OVER(ORDER BY CAST(created_at AS DATE) ASC) AS cumulative_spend
      FROM  user_selection_orders_items
  )

SELECT  date_of_spend,
        ROUND(cumulative_spend, 2) AS cumulative_spend
  FROM  raw_cumulative_spend;
        </code>
      </pre>
    </div>
  </div>
</div>
